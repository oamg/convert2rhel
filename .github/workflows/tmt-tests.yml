name: tmt@TF

on:
  issue_comment:
    types:
      - created

# See: https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency.
# This will ensure that only one commit will be running tests at a time on each PR.
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  checks: read

jobs:
  wait_for_rpm_builds:
    name: Wait for CI Checks
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI Checks
        uses: r0x0d/wait-for-ci-checks@main
        id: status_check
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          checkNames: "rpm-build:epel-7-x86_64;rpm-build:epel-8-x86_64"
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

  call_workflow_get_copr_id:
    needs: [wait_for_rpm_builds]
    uses: ./.github/workflows/reuse-get-copr-id.yml
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

  call_workflow_integration_tests_epel_7_tier0:
    needs: [call_workflow_get_copr_id]
    uses: ./.github/workflows/reuse-int-tests.yml
    with:
      copr: "epel-7-x86_64"
      copr_artifacts: ${{ needs.call_workflow_get_copr_id.outputs.artifacts }}
      tmt_plan_regex: "^(?!.*tier0)"
      distros: '["centos-7", "oraclelinux-7"]'
      pull_request_status_name: "epel-7-tier0"
    secrets: inherit
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

  call_workflow_integration_tests_epel_8_tier0:
    needs: [call_workflow_get_copr_id]
    uses: ./.github/workflows/reuse-int-tests.yml
    with:
      copr_artifacts: ${{ needs.call_workflow_get_copr_id.outputs.artifacts }}
      tmt_plan_regex: "^(?!.*tier0)"
      distros: '["centos-8.4", "centos-8", "oraclelinux-8.4", "oraclelinux-8.6"]'
      pull_request_status_name: "epel-8-tier0"
    secrets: inherit
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

  call_workflow_integration_tests_epel_7_tier1:
    needs: [call_workflow_get_copr_id]
    uses: ./.github/workflows/reuse-int-tests.yml
    with:
      copr: "epel-7-x86_64"
      copr_artifacts: ${{ needs.call_workflow_get_copr_id.outputs.artifacts }}
      tmt_plan_regex: "^(?!.*tier1)"
      distros: '["centos-7", "oraclelinux-7"]'
      pull_request_status_name: "epel-7-tier1"
    secrets: inherit
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

  call_workflow_integration_tests_epel_8_tier1:
    needs: [call_workflow_get_copr_id]
    uses: ./.github/workflows/reuse-int-tests.yml
    with:
      copr_artifacts: ${{ needs.call_workflow_get_copr_id.outputs.artifacts }}
      tmt_plan_regex: "^(?!.*tier1)"
      distros: '["centos-8.4", "centos-8", "oraclelinux-8.4", "oraclelinux-8.6"]'
      pull_request_status_name: "epel-8-tier1"
    secrets: inherit
    if: |
      github.event.issue.pull_request
      && startsWith(github.event.comment.body, '/rerun-all')
      && contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
