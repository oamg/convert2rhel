summary: Unsupported kmod behavior
description: |
    Load kernel module that is not supported in RHEL and verify the conversion is inhibited.
    Verify, that removing this kmod does not interfere with new conversion run.
    Verify that loading custom kernel module, that marks the kernel as "tainted", inhibits the conversion.

tier: 0

tag+:
    - kmod
    - kernel
    - inhibit-if-kmod-is-not-supported

/custom_module_loaded:
    tag+:
        - custom-module-loaded
    test: |
        pytest -svv -m custom_module_loaded

/custom_module_not_loaded:
    adjust+:
        - environment+:
            PROMPT_AMOUNT: 5
          when: distro == centos
        - environment+:
            PROMPT_AMOUNT: 4
          when: distro == oraclelinux-7
        - environment+:
            PROMPT_AMOUNT: 3
          when: distro == oraclelinux-8
    tag+:
        - custom-module-not-loaded
    test: |
        pytest -svv -m custom_module_not_loaded


/force_loaded_kmod:
    adjust+:
        - enabled: false
          when: distro == centos-7 or distro == oraclelinux-7
          because: |
            Force loading the kernel module on RHEL7 like distros is flaky.
    tag+:
        - force-loaded-kmod
    test: |
        pytest -svv -m force_loaded_kmod


/tainted_kernel:
    tag+:
        - tainted-kernel
    test: |
        pytest -svv -m tainted_kernel


/unsupported_kmod_with_envar:
    adjust+:
        - environment+:
            CONVERT2RHEL_ALLOW_UNAVAILABLE_KMODS: 1
        - environment+:
            PROMPT_AMOUNT: 6
          when: distro == centos-8-latest
        - environment+:
            PROMPT_AMOUNT: 5
          when: distro == centos-8.4, centos-7
        - environment+:
            PROMPT_AMOUNT: 4
          when: distro == oraclelinux-7
        - environment+:
            PROMPT_AMOUNT: 3
          when: distro == oraclelinux-8
    tag+:
        - unsupported-kmod-with-envar
    test: |
        pytest -svv -m unsupported_kmod_with_envar
    link:
        verifies: https://issues.redhat.com/browse/RHELC-244
